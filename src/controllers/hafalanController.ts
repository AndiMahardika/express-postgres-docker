import { Request, Response } from "express";
import { HafalanService } from "../services/hafalanService";
import { AuthRequest } from "../middleware/auth";
import { getUstadzByUserId } from "../repositories/ustadzRepo";
import { StatusHafalan, TahapHafalan } from "@prisma/client";

export const getSurahProgress = async (req: Request, res: Response) => {
  try {
    const { santriId } = req.params;
    const result = await HafalanService.getSurahProgress(Number(santriId));
    res.status(200).json({ message: "Surah retrieved", status: 200, ...result });
  } catch (error: any) {
    // res.status(500).json({ message: error.message || "Internal server error", status: 500 });
    res.status(500).json({ message: "Internal server error", status: 500 });
  }
};

export const getDetailHafalanSurah = async (req: Request, res: Response) => {
  try {
    const { santriId, surahId } = req.params;
    const { mode } = req.query;
    const result = await HafalanService.getDetailHafalanSurah(Number(santriId), Number(surahId), String(mode));
    res.status(200).json(result);
  } catch (error: any) {
    res.status(500).json({ message: error.message, status: 500 });
  }
};

export const simpanHafalan = async (req: AuthRequest, res: Response) => {
  const role = req.user?.role;
  const userId = req.user?.id;
  let ustadzId;

  try {
    const { santriId, ayatIds, status, catatan } = req.body;

    if (!userId || !role) {
      return res.status(401).json({ message: "Unauthorized", status: 401 });
    }

    if (role === "ustadz") {
      const ustadz = await getUstadzByUserId(userId);

      if (!ustadz) {
        return res.status(403).json({ message: "Ustadz not found for the authenticated user.", status: 403 });
      }
      ustadzId = ustadz.id;
    } else if (role === "admin") {
      const ustadzIdFromBody = req.body.ustadzId;
      if (!ustadzIdFromBody) {
        return res.status(400).json({ message: "Ustadz ID is required for admin role.", status: 400 });
      }
      ustadzId = Number(ustadzIdFromBody);
    } else {
      return res.status(403).json({ message: "Forbidden: You do not have permission to save hafalan.", status: 403 });
    }

    const result = await HafalanService.simpanHafalan(Number(santriId), ustadzId, ayatIds, status, catatan);
    res.status(200).json({ ...result, status: 200 });
  } catch (error: any) {
    res.status(400).json({ message: error.message, status: 400 });
  }
};

export const getRiwayatHafalanBySantri = async (req: Request, res: Response) => {
  try {
    const { santriId } = req.params;
    const page = parseInt((req.query.page as string) || "1");
    const limit = parseInt((req.query.limit as string) || "10");
    const sort = req.query.sort as string; // 'tanggal' or 'status'
    const sortBy = req.query.sortBy as string; // 'asc' or 'desc'
    const status = req.query.status as string; 

    const result = await HafalanService.getRiwayatHafalanBySantri(Number(santriId), page, limit, sort, sortBy, status);

    if (!result.santri) {
      return res.status(404).json({
        message: "Santri not found",
        status: 404,
      });
    }

    return res.json({
      message: "Success retrieve riwayat hafalan",
      status: 200,
      ...result,
    });
  } catch (error) {
    console.error(error);
    return res.status(500).json({
      message: "Internal Server Error",
      status: 500,
    });
  }
};

export const deleteRiwayatHafalan = async (req: Request, res: Response) => {
  try {
    const { santriId, surahId, tanggal, status } = req.body;

    if (!santriId || !surahId || !tanggal || !status) {
      return res.status(400).json({
        message: "SantriId, surahId, tanggal, dan status are required.",
        status: 400,
      });
    }

    const result = await HafalanService.deleteRiwayatHafalan(
      Number(santriId),
      Number(surahId),
      String(tanggal),
      String(status)
    );

    if (result.count === 0) {
      return res.status(404).json({
        message: "Riwayat hafalan not found",
        status: 404,
      });
    }

    return res.json({
      message: result.message,
      status: 200,
      deletedCount: result.count,
    });
  } catch (error) {
    console.error(error);
    return res.status(500).json({
      message: "Internal server error",
      status: 500,
    });
  }
};

export const getRiwayatDetailByDateAndSurah = async (req: Request, res: Response) => {
  try {
    const { santriId, surahId } = req.params;
    const { tanggal, status } = req.query;

    if (!santriId || !surahId || !tanggal || !status) {
      return res.status(400).json({
        message: "SantriId, surahId, tanggal, dan status are required.",
        status: 400,
      });
    }

    const result = await HafalanService.getRiwayatDetailByDateAndSurah(
      Number(santriId),
      Number(surahId),
      String(tanggal),
      String(status)
    );

    if (!result) {
      return res.status(404).json({
        message: "Riwayat detail hafalan not found.",
        status: 404,
      });
    }

    return res.status(200).json({
      message: "Detail riwayat hafalan retrieved.",
      status: 200,
      data: result,
    });
  } catch (error) {
    console.error(error);
    return res.status(500).json({
      message: "Internal server error",
      status: 500,
    });
  }
};

export const getLatestHafalanAllSantri = async (req: Request, res: Response) => {
  try { 
    const page = parseInt((req.query.page as string) || "1");
    const limit = parseInt((req.query.limit as string) || "10");
    const sortByAyat = req.query.sortByAyat as string | undefined;
    const name = req.query.name as string | undefined;
    let tahapHafalan: TahapHafalan | undefined;
    const statusQuery = req.query.status as string | undefined;
    let statusFilter: StatusHafalan | undefined

    if (statusQuery) {
      const statusMap: Record<string, StatusHafalan> = {
          tambahhafalan: StatusHafalan.TambahHafalan,
          murajaah: StatusHafalan.Murajaah,
      };
      const statusNormalized = statusQuery.toLowerCase();
      statusFilter = statusMap[statusNormalized];
    }

    if (req.query.tahapHafalan) {
      const tahapQuery = req.query.tahapHafalan as string;
      const tahapNormalized = tahapQuery.toLowerCase();
      const tahapMap: Record<string, TahapHafalan> = {
        level1: TahapHafalan.Level1,
        level2: TahapHafalan.Level2,
        level3: TahapHafalan.Level3,
      };
      tahapHafalan = tahapMap[tahapNormalized];
    }

    const result = await HafalanService.getLatestHafalanAllSantri(page, limit, tahapHafalan, statusFilter, sortByAyat, name);
    
    res.status(200).json({ status: 200, ...result });
  } catch (error: any) {
    console.error(error);
    return res.status(500).json({
      message: "Internal Server Error",
      status: 500,
    });
  }
};
